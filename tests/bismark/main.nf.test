import com.askimed.nf.test.util.FileUtil;

nextflow_pipeline {

    name "BISMARK"
    script "main.nf"

    test("BISMARK_Single_End") {
        when {
            params {
                aligner = "bismark"
                save_reference = true
                outdir = "$outputDir"
            }
        }

        then {
            // Clean up anything from previous runs
            FileUtil.deleteDirectory(new File(".nf-test/indexes/"));
            new File(".nf-test/indexes/").mkdirs()
            // Copy the ref genome to a stable location for next tests
            FileUtil.copyDirectory(
                new File("$outputDir/bismark/reference_genome/BismarkIndex/").getAbsolutePath(),
                new File(".nf-test/indexes/BismarkIndex/").getAbsolutePath()
            )

            // Assert Workflow Success
            assert workflow.success

            // Snapshot
            assert snapshot(path("$outputDir/bismark/methylation_calls/splitting_report/Ecoli_10K_methylated_1_val_1_bismark_bt2_pe.deduplicated_splitting_report.txt"),
                            path("$outputDir/bismark/methylation_calls/splitting_report/SRR389222_sub1_trimmed_bismark_bt2.deduplicated_splitting_report.txt"),
                            path("$outputDir/bismark/methylation_calls/splitting_report/SRR389222_sub2_trimmed_bismark_bt2.deduplicated_splitting_report.txt"),
                            path("$outputDir/bismark/summary/bismark_summary_report.txt"),
                            path("$outputDir/qualimap/Ecoli_10K_methylated/genome_results.txt"),
                            path("$outputDir/qualimap/SRR389222_sub1/genome_results.txt"),
                            path("$outputDir/qualimap/SRR389222_sub2/genome_results.txt"),
                            path("$outputDir/pipeline_info/software_versions.yml")).match("bismark_single_end")
        }
    }

    test("BISMARK_Single_End_With_Index") {
        when {
            params {
                aligner = "bismark"
                // Generated by previous test
                bismark_index = ".nf-test/indexes/BismarkIndex/"
                cytosine_report = true
                outdir = "$outputDir"
            }
        }

        then {
            // Assert Workflow Success
            assert workflow.success
        }
    }

    test("BISMARK_Single_End_RRBS") {
        when {
            params {
                aligner = "bismark"
                skip_trimming = true
                save_reference = true
                rrbs = true
                outdir = "$outputDir"
            }
        }

        then {
            // Assert Workflow Success
            assert workflow.success

            // Snapshot
            assert snapshot(path("$outputDir/bismark/methylation_calls/splitting_report/Ecoli_10K_methylated_R1_bismark_bt2_pe_splitting_report.txt"),
                            path("$outputDir/bismark/methylation_calls/splitting_report/SRR389222_sub1_bismark_bt2_splitting_report.txt"),
                            path("$outputDir/bismark/methylation_calls/splitting_report/SRR389222_sub2.merged_bismark_bt2_splitting_report.txt"),
                            path("$outputDir/bismark/summary/bismark_summary_report.txt"),
                            path("$outputDir/qualimap/Ecoli_10K_methylated/genome_results.txt"),
                            path("$outputDir/qualimap/SRR389222_sub1/genome_results.txt"),
                            path("$outputDir/qualimap/SRR389222_sub2/genome_results.txt"),
                            path("$outputDir/pipeline_info/software_versions.yml")).match("bismark_single_end_rrbs")
        }
    }

    test("BISMARK_Single_End_RRBS_With_Index") {
        when {
            params {
                aligner = "bismark"
                skip_trimming = true
                rrbs = true
                // Generated by previous test
                bismark_index = ".nf-test/indexes/BismarkIndex/"
                cytosine_report = true
                outdir = "$outputDir"
            }
        }

        then {
            // Assert Workflow Success
            assert workflow.success
        }
    }

    test("BISMARK_Single_End_NOMe-seq") {
        when {
            params {
                aligner = "bismark"
                nomeseq = true
                outdir = "$outputDir"
            }
        }

        then {
            // Assert Workflow Success
            assert workflow.success

            // Snapshot
            assert snapshot(path("$outputDir/bismark/methylation_calls/splitting_report/Ecoli_10K_methylated_1_val_1_bismark_bt2_pe.deduplicated_splitting_report.txt"),
                            path("$outputDir/bismark/methylation_calls/splitting_report/SRR389222_sub1_trimmed_bismark_bt2.deduplicated_splitting_report.txt"),
                            path("$outputDir/bismark/methylation_calls/splitting_report/SRR389222_sub2_trimmed_bismark_bt2.deduplicated_splitting_report.txt"),
                            path("$outputDir/bismark/summary/bismark_summary_report.txt"),
                            path("$outputDir/qualimap/Ecoli_10K_methylated/genome_results.txt"),
                            path("$outputDir/qualimap/SRR389222_sub1/genome_results.txt"),
                            path("$outputDir/qualimap/SRR389222_sub2/genome_results.txt"),
                            path("$outputDir/pipeline_info/software_versions.yml")).match("bismark_single_end_nomeseq")
        }
    }

    test("BISMARK_Clipping_Params") {
        when {
            params {
                aligner = "bismark"
                em_seq = true
                clip_r1 = 2
                outdir = "$outputDir"
            }
        }

        then {
            // Assert Workflow Success
            assert workflow.success

            // Snapshot
            assert snapshot(path("$outputDir/bismark/summary/bismark_summary_report.txt")).match("bismark_clipping_params")
        }
    }

}
